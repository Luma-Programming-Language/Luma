@module "main"  

@use "parser" as parser
@use "lexer" as lexer
@use "vector" as vec
@use "common" as com
@use "vm" as vm
@use "io" as io

pub const main -> fn () int {
    let token_vector: Vector = vec::create_vector(sizeof<Token>);
    let path: *byte = "/home/connor/projects/Luma/tests/VM/text.txt";
    let file: *byte = io::read_file(path);
    defer { 
        vec::free_vector(&token_vector);
        free(file); 
    }

    let lx: Lexer = lexer::create_lexer(file);
    loop {
        let tok: Token = lexer::next_token(&lx);
        if (tok.kind == com::TokenKind::EOF) break;
        token_vector.push_back(cast<*void>(&tok));
    }
    
    let tokens: *Token = cast<*Token>(token_vector.data);
    let psr: Parser = parser::create_parser(tokens, token_vector.size);
    defer { parser::free_parser(&psr); }
    
    parser::parse(&psr);
    parser::print_instructions(&psr);
    
    // Create VM and assemble the bytecode
    let virtual_machine: VM = vm::create_vm();
    defer { vm::free_vm(&virtual_machine); }
    
    parser::assemble(&psr, &virtual_machine);
    
    // Execute!
    vm::vm_execute(&virtual_machine);

    return 0;
}
